<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reading Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;

  /* PATCH: flat colors */
  --start:#22c55e;
  --start-text:#052e16;
  --stop:#ef4444;
  --stop-text:#7f1d1d;

  --accent:#60a5fa;
  --warning:#f59e0b;
}
[data-theme="light"]{
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#020617;
  --muted:#475569;

  --start:#16a34a;
  --start-text:#052e16;
  --stop:#dc2626;
  --stop-text:#7f1d1d;

  --accent:#2563eb;
  --warning:#f59e0b;
}

body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
.container{max-width:980px;margin:auto;padding:16px}

/* PATCH: input width unification */
input,select,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  margin-top:8px;
  box-sizing:border-box;
}

input,select{
  background:var(--border);
  color:var(--text);
}

button{
  font-weight:700;
  cursor:pointer;
}

/* PATCH: flat buttons */
.start-btn{background:var(--start);color:white}
.start-btn:disabled{opacity:0.5;cursor:not-allowed}
.pause-btn{background:#f59e0b;color:white}
.pause-btn:disabled{opacity:0.5;cursor:not-allowed}
.pause-btn.resume{background:var(--start)}
.stop-btn{background:var(--stop);color:white}
.stop-btn:disabled{opacity:0.5;cursor:not-allowed}

.card{
  background:var(--card);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

.timer{text-align:center;font-size:2rem;margin-top:12px}

.flex{display:flex;gap:12px;flex-wrap:wrap}
.stat{background:var(--border);padding:12px;border-radius:12px;flex:1}

.divider{height:1px;background:var(--border);margin:12px 0}

table{width:100%;border-collapse:collapse;overflow-x:auto;display:block}
thead{display:table;width:100%;table-layout:fixed}
tbody{display:table;width:100%;table-layout:fixed}
th,td{padding:10px;border-bottom:1px solid var(--border);word-wrap:break-word;overflow-wrap:break-word}
th:nth-child(1),td:nth-child(1){width:30%}
th:nth-child(2),td:nth-child(2){width:25%}
th:nth-child(3),td:nth-child(3){width:20%}
th:nth-child(4),td:nth-child(4){width:25%}

@media(max-width:768px){
  th,td{padding:8px 4px;font-size:13px}
  th:nth-child(1),td:nth-child(1){width:35%}
  th:nth-child(2),td:nth-child(2){width:25%}
  th:nth-child(3),td:nth-child(3){width:15%}
  th:nth-child(4),td:nth-child(4){width:25%}
}

@media(max-width:480px){
  th,td{padding:6px 2px;font-size:12px}
  th:nth-child(1),td:nth-child(1){width:40%;font-size:11px}
  th:nth-child(2),td:nth-child(2){width:30%;font-size:11px}
  th:nth-child(3),td:nth-child(3){width:12%;text-align:center}
  th:nth-child(4),td:nth-child(4){width:18%;font-size:11px}
}

.pagination{display:flex;justify-content:center;gap:6px;margin-top:14px}
.page-btn{padding:8px 14px;border-radius:999px;background:var(--border);cursor:pointer}
.page-btn.active{background:var(--accent);color:white}
.page-btn.disabled{opacity:.4;pointer-events:none}

/* PATCH: empty state */
.empty{
  text-align:center;
  color:var(--muted);
  padding:12px;
}

/* MODAL */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal{
  background:var(--card);
  color:var(--text);
  border-radius:16px;
  padding:20px;
  width:85%;
  max-width:360px;
  text-align:center;
  box-shadow:0 20px 25px -5px rgba(0,0,0,.3);
}
.modal h3{
  margin-top:0;
  font-size:18px;
}
.modal p{
  color:var(--muted);
  font-size:14px;
  margin:8px 0;
}
.modal button{
  background:var(--accent);
  color:white;
  margin-top:8px;
  font-size:14px;
}
.modal-actions{
  display:flex;
  gap:8px;
  margin-top:12px;
}
.modal-actions button{
  flex:1;
}
.cancel-btn{
  background:var(--border)!important;
  color:var(--text)!important;
}

.spinner{
  width:28px;height:28px;
  border:4px solid var(--border);
  border-top:4px solid var(--accent);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:12px auto;
}
@keyframes spin{to{transform:rotate(360deg)}}

.loading-container{
  text-align:center;
  width:100%;
}
.loading-text{
  text-align:center;
  color:var(--muted);
  margin-top:8px;
  font-size:14px;
}

/* No internet banner */
.no-internet-banner{
  background:#ef4444;
  color:#fff;
  padding:14px;
  border-radius:12px;
  text-align:center;
  font-weight:600;
  margin-bottom:16px;
  display:none;
  font-size:15px;
  align-items:center;
  justify-content:center;
  gap:12px;
}
.no-internet-banner.show{
  display:flex;
}
.no-internet-banner.restored{
  background:#22c55e;
}
.no-internet-banner .spinner{
  width:20px;
  height:20px;
  border:3px solid rgba(255,255,255,0.3);
  border-top:3px solid #fff;
  margin:0;
}

/* Queue banner */
.queue-banner{
  background:var(--warning);
  color:#000;
  padding:12px;
  border-radius:12px;
  margin-bottom:16px;
  display:none;
  align-items:center;
  gap:12px;
}
.queue-banner.show{
  display:flex;
}
.queue-text{
  flex:1;
}
.queue-retry{
  background:#000;
  color:#fff;
  padding:8px 16px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  border:none;
  width:auto;
  margin:0;
}

/* No internet banner per section (removed) */

/* Floating Timer */
.floating-timer{
  position:fixed;
  bottom:20px;
  right:20px;
  background:var(--card);
  border-radius:20px;
  padding:16px 20px;
  box-shadow:0 8px 32px rgba(0,0,0,.3);
  display:none;
  flex-direction:column;
  gap:12px;
  z-index:999;
  min-width:200px;
  border:1px solid var(--border);
}
.floating-timer.show{
  display:flex;
  animation:slideUp 0.3s ease;
}
.floating-timer.minimized{
  padding:12px 16px;
}
.floating-timer.minimized .floating-controls,
.floating-timer.minimized .floating-info{
  display:none;
}
@keyframes slideUp{
  from{transform:translateY(100px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
.floating-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}
.floating-title{
  font-size:12px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
  font-weight:600;
}
.floating-actions{
  display:flex;
  gap:4px;
}
.floating-icon-btn{
  background:var(--border);
  border:none;
  width:24px;
  height:24px;
  border-radius:6px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  color:var(--text);
  padding:0;
  margin:0;
}
.floating-icon-btn:hover{
  background:var(--accent);
  color:white;
}
.floating-display{
  text-align:center;
}
.floating-time{
  font-size:32px;
  font-weight:700;
  font-variant-numeric:tabular-nums;
  letter-spacing:-1px;
  color:var(--text);
}
.floating-info{
  text-align:center;
  font-size:11px;
  color:var(--muted);
  padding:8px;
  background:var(--border);
  border-radius:8px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.floating-controls{
  display:flex;
  gap:8px;
}
.floating-btn{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:none;
  font-weight:600;
  cursor:pointer;
  font-size:13px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:4px;
  margin:0;
  width:auto;
  height:auto;
}
.floating-pause{
  background:var(--warning);
  color:white;
}
.floating-pause.resume{
  background:var(--start);
}
.floating-stop{
  background:var(--stop);
  color:white;
}

@media(max-width:768px){
  .floating-timer{
    bottom:16px;
    right:16px;
    left:16px;
    min-width:unset;
    max-width:calc(100vw - 32px);
  }
  .floating-time{
    font-size:28px;
  }
  .floating-info{
    font-size:10px;
  }
}

ul{list-style:none;padding:0}
li{padding:6px 0;border-bottom:1px solid var(--border)}
a{
  color:var(--accent);
  text-decoration:none;
  word-wrap:break-word;
  overflow-wrap:break-word;
  word-break:break-all;
  display:block;
  line-height:1.4;
}
</style>
</head>

<body>
<div class="container">

<!-- No Internet Banner -->
<div class="no-internet-banner" id="noInternetBanner">
  <span id="connectionMessage">No internet connection, please try again...</span>
  <div class="spinner" id="connectionSpinner"></div>
</div>

<!-- Queue Banner -->
<div class="queue-banner" id="queueBanner">
  <div class="queue-text">
    <strong>Sync Failed</strong><br>
    <span id="queueCount">1</span> session(s) queued for sync
  </div>
  <button class="queue-retry" onclick="toggleQueueList()">View Queue</button>
  <button class="queue-retry" onclick="retrySync()">Retry Now</button>
</div>

<!-- Queue List -->
<div class="card" id="queueCard" style="display:none">
<h3>üìã Queued Sessions</h3>
<p style="color:var(--muted);font-size:14px">These sessions failed to sync and will be retried automatically or manually.</p>
<table>
<thead>
<tr>
  <th>Timestamp</th>
  <th>Site</th>
  <th>Chapter</th>
  <th>Duration</th>
</tr>
</thead>
<tbody id="queueTableBody"></tbody>
</table>
</div>

<!-- HEADER (PATCH: themeSelect moved below title) -->
<div class="card">
  <h1>üìñ Reading Tracker</h1>
  <select id="themeSelect">
    <option value="system">System</option>
    <option value="light">Light</option>
    <option value="dark">Dark</option>
  </select>
</div>

<!-- SESSION -->
<div class="card">
  <input id="urlInput" placeholder="Paste URL">
  <button id="startBtn" class="start-btn">‚ñ∂ Start Reading</button>
  <button id="pauseBtn" class="pause-btn" disabled>‚è∏ Pause</button>
  <button id="stopBtn" class="stop-btn" disabled>‚ñ† Stop & Sync</button>
  <div class="timer" id="timer">00:00:00</div>
</div>

<!-- ANALYTICS -->
<div class="card">
<h3>üìä Analytics</h3>
<label>Date Range</label>
<select id="dateFilter">
  <option value="all">All Time</option>
  <option value="today">Today</option>
  <option value="7">Last 7 Days</option>
  <option value="30">Last 30 Days</option>
</select>

<div class="divider"></div>

<div class="flex">
  <div class="stat"><strong>Total Sessions</strong><br><span id="statSessions">‚Äî</span></div>
  <div class="stat"><strong>Total Time Spent Reading</strong><br><span id="statTime">‚Äî</span></div>
  <div class="stat"><strong>This Week</strong><br><span id="statWeek">‚Äî</span></div>
  <div class="stat"><strong>Streak</strong><br><span id="statStreak">‚Äî</span></div>
</div>

<div class="divider"></div>
<strong>Time Spent Per Visited Page</strong>
<div id="perSite" class="flex" style="margin-top:12px">
  <div class="loading-container">
    <div class="spinner"></div>
    <div class="loading-text">Loading analytics...</div>
  </div>
</div>
</div>

<!-- VISITED LINKS -->
<div class="card">
<h3>üîó Visited Links</h3>
<label>Filter</label>
<select id="linkFilter">
  <option value="recent">Recent</option>
  <option value="newest">Newest</option>
</select>
<ul id="visitedLinks">
  <li class="empty">
    <div class="loading-container">
      <div class="spinner"></div>
      <div class="loading-text">Loading visited links...</div>
    </div>
  </li>
</ul>
</div>

<!-- SESSION HISTORY -->
<div class="card">
<h3>üïí Session History</h3>
<label>Search</label>
<input id="searchInput" placeholder="Search site, chapter, URL">
<div class="divider"></div>
<table>
<thead>
<tr>
  <th>Timestamp</th>
  <th>Site</th>
  <th>Chapter</th>
  <th>Duration</th>
</tr>
</thead>
<tbody id="tableBody">
  <tr>
    <td colspan="4">
      <div class="loading-container">
        <div class="spinner"></div>
        <div class="loading-text">Loading session history...</div>
      </div>
    </td>
  </tr>
</tbody>
</table>
<div class="pagination" id="pagination"></div>
</div>

</div>

<!-- MODAL -->
<div class="modal-bg" id="modal">
  <div class="modal" id="modalContent"></div>
</div>

<!-- Floating Timer -->
<div class="floating-timer" id="floatingTimer">
  <div class="floating-header">
    <span class="floating-title">Reading Session</span>
    <div class="floating-actions">
      <button class="floating-icon-btn" onclick="toggleMinimize()" title="Minimize">‚àí</button>
      <button class="floating-icon-btn" onclick="hideFloating()" title="Hide">√ó</button>
    </div>
  </div>
  <div class="floating-display">
    <div class="floating-time" id="floatingTime">00:00:00</div>
  </div>
  <div class="floating-info" id="floatingUrl">No URL</div>
  <div class="floating-controls">
    <button class="floating-btn floating-pause" id="floatingPause" onclick="pauseBtn.click()">
      <span id="floatingPauseIcon">‚è∏</span>
      <span id="floatingPauseText">Pause</span>
    </button>
    <button class="floating-btn floating-stop" onclick="stopBtn.click()">‚ñ† Stop</button>
  </div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbx-ald2rfnwCWOzxh9VY1UXvZnjr0h0b5_U_0EYoUTJ_2-Hip0PQMn0Hrz7G7IDgWbk/exec";

/* QUEUE SYSTEM */
let queuedSessions=[];
function loadQueue(){
  const saved=localStorage.getItem("queuedSessions");
  if(saved){
    queuedSessions=JSON.parse(saved);
    updateQueueBanner();
    renderQueueTable();
  }
}
function saveQueue(){
  localStorage.setItem("queuedSessions",JSON.stringify(queuedSessions));
  updateQueueBanner();
  renderQueueTable();
}
function updateQueueBanner(){
  const banner=document.getElementById("queueBanner");
  const count=document.getElementById("queueCount");
  if(queuedSessions.length>0){
    count.textContent=queuedSessions.length;
    banner.classList.add("show");
  }else{
    banner.classList.remove("show");
    document.getElementById("queueCard").style.display="none";
  }
}
function toggleQueueList(){
  const card=document.getElementById("queueCard");
  card.style.display=card.style.display==="none"?"block":"none";
}
function renderQueueTable(){
  const tbody=document.getElementById("queueTableBody");
  if(queuedSessions.length===0){
    tbody.innerHTML=`<tr><td colspan="4" class="empty">No queued sessions</td></tr>`;
    return;
  }
  tbody.innerHTML=queuedSessions.map((s,i)=>`
    <tr>
      <td>${s.timestamp||new Date().toLocaleString()}</td>
      <td>${s.site}</td>
      <td>${s.chapter}</td>
      <td>${s.duration}</td>
    </tr>
  `).join("");
}
async function retrySync(){
  if(queuedSessions.length===0)return;
  
  openModal(`
    <h3>Syncing Queued Sessions</h3>
    <div class="spinner"></div>
    <div class="loading-text">Syncing ${queuedSessions.length} session(s)</div>
  `);
  
  const failed=[];
  for(const session of queuedSessions){
    try{
      const response=await fetch(SCRIPT_URL,{
        method:"POST",
        body:JSON.stringify(session)
      });
      if(!response.ok) throw new Error("Network response failed");
    }catch{
      failed.push(session);
    }
  }
  
  queuedSessions=failed;
  saveQueue();
  
  if(failed.length===0){
    await Promise.all([loadAnalytics(), loadHistory()]);
    openModal(`<h3>‚úÖ All Synced</h3><p>All queued sessions have been synced successfully</p><button onclick="closeModal()">OK</button>`);
  }else{
    openModal(`<h3>‚ö†Ô∏è Partial Sync</h3><p>${failed.length} session(s) still failed to sync</p><button onclick="closeModal()">OK</button>`);
  }
}

/* THEME */
const root=document.documentElement;
const themeSelect=document.getElementById("themeSelect");
const saved=localStorage.getItem("theme");
function applyTheme(v){
  if(v==="light") root.dataset.theme="light";
  else if(v==="dark") root.dataset.theme="dark";
  else{
    root.removeAttribute("data-theme");
    if(window.matchMedia("(prefers-color-scheme: light)").matches){
      root.dataset.theme="light";
    }
  }
}
themeSelect.value=saved||"system";
applyTheme(themeSelect.value);
themeSelect.onchange=()=>{
  localStorage.setItem("theme",themeSelect.value);
  applyTheme(themeSelect.value);
};

/* MODAL */
const modal=document.getElementById("modal");
const modalContent=document.getElementById("modalContent");
function openModal(h){modalContent.innerHTML=h;modal.style.display="flex"}
function closeModal(){modal.style.display="none"}

/* HELPERS */
function toSec(d){const[a,b,c]=d.split(":").map(Number);return a*3600+b*60+c}
function human(s){
  if(s<60) return s+" sec";
  if(s<3600) return Math.floor(s/60)+" min";
  return Math.floor(s/3600)+" hr";
}
function fmt(ms){
  const s=Math.floor(ms/1000);
  return `${String(Math.floor(s/3600)).padStart(2,"0")}:${String(Math.floor(s%3600/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
}

/* DATA */
let analyticsRows=[];
let hasInternetConnection=navigator.onLine;

function updateInternetStatus(online){
  const banner=document.getElementById("noInternetBanner");
  const message=document.getElementById("connectionMessage");
  const spinner=document.getElementById("connectionSpinner");
  
  if(online && !hasInternetConnection){
    // Connection restored
    hasInternetConnection=true;
    banner.classList.add("restored");
    spinner.style.display="block";
    message.textContent="Connection restored...";
    
    // Auto-refresh data
    loadAnalytics();
    loadHistory();
    
    // Hide banner after 3 seconds
    setTimeout(()=>{
      banner.classList.remove("show","restored");
      message.textContent="No internet connection, please try again...";
    },3000);
  }else if(!online){
    // Connection lost
    hasInternetConnection=false;
    banner.classList.remove("restored");
    banner.classList.add("show");
    message.textContent="No internet connection, please try again...";
    spinner.style.display="block";
    
    // Keep existing data visible, don't clear it
  }
}

// Real-time internet connection detection
window.addEventListener('online',()=>{
  console.log('Connection restored');
  updateInternetStatus(true);
});

window.addEventListener('offline',()=>{
  console.log('Connection lost');
  updateInternetStatus(false);
});

async function loadAnalytics(){
  statSessions.textContent="‚Äî";
  statTime.textContent="‚Äî";
  statWeek.textContent="‚Äî";
  statStreak.textContent="‚Äî";
  perSite.innerHTML=`<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading analytics...</div></div>`;
  
  // Show loading state for visited links too
  visitedLinks.innerHTML=`<li class="empty"><div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading visited links...</div></div></li>`;

  try{
    const res=await fetch(`${SCRIPT_URL}?mode=analytics`);
    if(!res.ok) throw new Error("Network error");
    analyticsRows=await res.json();
    updateInternetStatus(true);

    /* PATCH: analytics empty state */
    if(!analyticsRows.length){
      statSessions.textContent="0";
      statTime.textContent="0 min";
      statWeek.textContent="0 min";
      statStreak.textContent="0 day";
      perSite.innerHTML=`<div class="empty">No data available</div>`;
      loadVisitedLinks();
      return;
    }

    renderAnalytics();
    loadVisitedLinks();
  }catch(err){
    console.error("Analytics load error:",err);
    updateInternetStatus(false);
    perSite.innerHTML=`<div class="empty">Failed to load analytics</div>`;
    visitedLinks.innerHTML=`<li class="empty">Failed to load visited links</li>`;
  }
}

function renderAnalytics(){
  // Show loading state
  statSessions.textContent="‚Äî";
  statTime.textContent="‚Äî";
  statWeek.textContent="‚Äî";
  statStreak.textContent="‚Äî";
  perSite.innerHTML=`<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading analytics...</div></div>`;
  
  // Reduced delay for snappier feel
  setTimeout(()=>{
    const now=new Date();
    const f=dateFilter.value;
    const filtered=analyticsRows.filter(r=>{
      const d=new Date(r.timestamp);
      if(f==="today") return d.toDateString()===now.toDateString();
      if(f==="7") return (now-d)/(86400000)<=7;
      if(f==="30") return (now-d)/(86400000)<=30;
      return true;
    });

    statSessions.textContent=filtered.length;

    let total=0,siteMap={},weekTotal=0;
    const weekAgo=new Date(now.getTime()-7*86400000);
    
    filtered.forEach(r=>{
      const s=toSec(r.duration);
      total+=s;
      siteMap[r.site]=(siteMap[r.site]||0)+s;
    });
    
    // Calculate "This Week" from ALL data, not just filtered data
    analyticsRows.forEach(r=>{
      const d=new Date(r.timestamp);
      if(d>=weekAgo){
        weekTotal+=toSec(r.duration);
      }
    });

    statTime.textContent=human(total);
    statWeek.textContent=human(weekTotal);
    statStreak.textContent="1 day";

    perSite.innerHTML=Object.keys(siteMap).length
      ? Object.entries(siteMap).map(([k,v]) =>
          `<div class="stat"><strong>${k}</strong><br>${human(v)}</div>`
        ).join("")
      : `<div class="empty">No data available</div>`;
  },150);
}

dateFilter.onchange=renderAnalytics;

/* VISITED LINKS */
function loadVisitedLinks(){
  visitedLinks.innerHTML=`<li class="empty"><div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading visited links...</div></div></li>`;
  
  setTimeout(()=>{
    try{
      const map=new Map();
      analyticsRows.forEach(r=>map.set(r.url,r));
      let links=[...map.values()];
      if(linkFilter.value==="newest") links.reverse();

      visitedLinks.innerHTML=links.length
        ? links.slice(0,10)
            .map(r=>`<li><a href="${r.url}" target="_blank">${r.url}</a></li>`)
            .join("")
        : `<li class="empty">No data available</li>`;
    }catch(err){
      console.error("Visited links error:",err);
      visitedLinks.innerHTML=`<li class="empty">Failed to load visited links</li>`;
    }
  },50);
}
linkFilter.onchange=loadVisitedLinks;

/* HISTORY */
let historyRows=[],page=1,totalPages=1;
async function loadHistory(){
  tableBody.innerHTML=`<tr><td colspan="4"><div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading session history...</div></div></td></tr>`;
  try{
    const res=await fetch(`${SCRIPT_URL}?page=${page}`);
    if(!res.ok) throw new Error("Network error");
    const j=await res.json();
    historyRows=j.data;
    totalPages=j.totalPages;
    updateInternetStatus(true);
    renderHistory();
    renderPagination();
  }catch(err){
    console.error("History load error:",err);
    updateInternetStatus(false);
    tableBody.innerHTML=`<tr><td colspan="4" class="empty">Failed to load session history</td></tr>`;
  }
}
function renderHistory(){
  const q=searchInput.value.toLowerCase();
  const rows=historyRows.filter(r=>`${r.site} ${r.chapter} ${r.url}`.toLowerCase().includes(q));
  if(!rows.length){
    tableBody.innerHTML=`<tr><td colspan="4" class="empty">No data available</td></tr>`;
    return;
  }
  tableBody.innerHTML=rows.map(r=>`
    <tr><td>${r.timestamp}</td><td>${r.site}</td><td>${r.chapter}</td><td>${r.duration}</td></tr>
  `).join("");
}
searchInput.oninput=renderHistory;

function renderPagination(){
  let h=`<span class="page-btn ${page===1?'disabled':''}" onclick="goPage(${page-1})">Previous</span>`;
  for(let i=1;i<=totalPages;i++){
    if(i===1||i===totalPages||Math.abs(i-page)<=1){
      h+=`<span class="page-btn ${i===page?'active':''}" onclick="goPage(${i})">${i}</span>`;
    }else if(i===page-2||i===page+2){h+="<span>‚Ä¶</span>"}
  }
  h+=`<span class="page-btn ${page===totalPages?'disabled':''}" onclick="goPage(${page+1})">Next</span>`;
  pagination.innerHTML=h;
}
function goPage(p){if(p<1||p>totalPages)return;page=p;loadHistory()}

/* TIMER */
let running=false,paused=false,lastActive=0,totalMs=0,interval=null,frozenURL="";
let isMinimized=false;

function toggleMinimize(){
  isMinimized=!isMinimized;
  const floatingTimer=document.getElementById("floatingTimer");
  if(isMinimized){
    floatingTimer.classList.add("minimized");
  }else{
    floatingTimer.classList.remove("minimized");
  }
}

function hideFloating(){
  document.getElementById("floatingTimer").classList.remove("show");
}

function showFloating(){
  document.getElementById("floatingTimer").classList.add("show");
  isMinimized=false;
  document.getElementById("floatingTimer").classList.remove("minimized");
}

function updateFloatingTimer(){
  const floatingTime=document.getElementById("floatingTime");
  const floatingUrl=document.getElementById("floatingUrl");
  const floatingPauseIcon=document.getElementById("floatingPauseIcon");
  const floatingPauseText=document.getElementById("floatingPauseText");
  const floatingPauseBtn=document.getElementById("floatingPause");
  
  if(!paused){
    floatingTime.textContent=fmt(totalMs+(Date.now()-lastActive));
  }
  
  if(paused){
    floatingPauseIcon.textContent="‚ñ∂";
    floatingPauseText.textContent="Resume";
    floatingPauseBtn.classList.add("resume");
  }else{
    floatingPauseIcon.textContent="‚è∏";
    floatingPauseText.textContent="Pause";
    floatingPauseBtn.classList.remove("resume");
  }
  
  floatingUrl.textContent=frozenURL||"No URL";
}

startBtn.onclick=()=>{
  if(running){openModal(`<p>Session already running</p><button onclick="closeModal()">OK</button>`);return}
  if(!urlInput.value){openModal(`<p>Please paste a URL</p><button onclick="closeModal()">OK</button>`);return}
  try{new URL(urlInput.value)}catch{openModal(`<p>Invalid URL</p><button onclick="closeModal()">OK</button>`);return}
  frozenURL=urlInput.value;
  running=true;paused=false;totalMs=0;lastActive=Date.now();
  urlInput.disabled=true;startBtn.disabled=true;pauseBtn.disabled=false;stopBtn.disabled=false;
  pauseBtn.textContent="‚è∏ Pause";
  pauseBtn.classList.remove("resume");
  
  showFloating();
  updateFloatingTimer();
  
  interval=setInterval(()=>{
    if(!paused){
      timer.textContent=fmt(totalMs+(Date.now()-lastActive));
      updateFloatingTimer();
    }
  },500);
  window.open(frozenURL,"_blank");
};

pauseBtn.onclick=()=>{
  if(!running)return;
  
  if(paused){
    // Resume
    paused=false;
    lastActive=Date.now();
    pauseBtn.textContent="‚è∏ Pause";
    pauseBtn.classList.remove("resume");
  }else{
    // Pause
    paused=true;
    totalMs+=Date.now()-lastActive;
    pauseBtn.textContent="‚ñ∂ Resume";
    pauseBtn.classList.add("resume");
  }
  updateFloatingTimer();
};

stopBtn.onclick=()=>{
  openModal(`
    <h3>Stop Reading Session?</h3>
    <p>Do you want to stop and sync this reading session?</p>
    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeModal()">Cancel</button>
      <button onclick="confirmStop()">Yes, Stop</button>
    </div>
  `);
};

async function confirmStop(){
  if(!paused){
    totalMs+=Date.now()-lastActive;
  }
  clearInterval(interval);
  hideFloating();
  
  openModal(`<h3>Syncing</h3><div class="spinner"></div>`);
  
  try{
    const u=new URL(frozenURL);
    const payload={
      site:u.hostname.replace(/^www\./,""),
      url:frozenURL,
      chapter:(frozenURL.match(/chapter[-_\/ ]?(\d+)/i)||[])[1]||"-",
      duration:fmt(totalMs)
    };
    
    const response=await fetch(SCRIPT_URL,{
      method:"POST",
      body:JSON.stringify(payload)
    });
    
    if(!response.ok) throw new Error("Network response failed");
    
    reset();
    
    // Parallel loading for faster refresh
    const [analyticsData,historyData]=await Promise.all([
      fetch(`${SCRIPT_URL}?mode=analytics`).then(r=>r.json()),
      fetch(`${SCRIPT_URL}?page=${page}`).then(r=>r.json())
    ]);
    
    analyticsRows=analyticsData;
    historyRows=historyData.data;
    totalPages=historyData.totalPages;
    
    renderAnalytics();
    loadVisitedLinks();
    renderHistory();
    renderPagination();
    
    closeModal();
    openModal(`<h3>‚úÖ Synced</h3><p>Your reading session has been saved successfully</p><button onclick="closeModal()">OK</button>`);
  }catch(err){
    console.error("Sync error:",err);
    
    const u=new URL(frozenURL);
    queuedSessions.push({
      timestamp:new Date().toLocaleString(),
      site:u.hostname.replace(/^www\./,""),
      url:frozenURL,
      chapter:(frozenURL.match(/chapter[-_\/ ]?(\d+)/i)||[])[1]||"-",
      duration:fmt(totalMs)
    });
    saveQueue();
    
    reset();
    
    openModal(`
      <h3>‚ö†Ô∏è Sync Failed</h3>
      <p>Your session has been saved locally and queued for sync. We'll retry automatically when connection is restored</p>
      <button onclick="closeModal()">OK</button>
    `);
  }
}

function reset(){
  running=false;paused=false;totalMs=0;frozenURL="";
  urlInput.value="";urlInput.disabled=false;
  startBtn.disabled=false;pauseBtn.disabled=true;stopBtn.disabled=true;
  pauseBtn.textContent="‚è∏ Pause";
  pauseBtn.classList.remove("resume");
  timer.textContent="00:00:00";
}

/* INIT */
// Check initial connection status
if(!navigator.onLine){
  updateInternetStatus(false);
}

loadQueue();
loadAnalytics();
loadHistory();
</script>
</body>
</html>